<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Registro de estoque di√°rio - Qdel√≠cia Frutas.">
    <title>Estoque - Qdel√≠cia Frutas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      /* --- VARI√ÅVEIS DE TEMA --- */
      :root {
        --primary-color: #5d3fd3; /* Roxo principal */
        --secondary-color: #8b5cf6; /* Roxo mais claro */
        --tertiary-color: #a78bfa; /* Roxo ainda mais claro */
        --accent-color: #39ff14; /* Verde neon para destaque/sucesso */
        --bg-light-form: #f3f0ff; /* Fundo claro com roxo */
        --white: #ffffff;
        --text-dark: #2c0e5a; /* Roxo escuro para texto */
        --shadow: rgba(0, 0, 0, 0.15); /* Sombra um pouco mais forte */
        --border-radius: 8px;
        --transition: all 0.3s ease;
        --gradient: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      }

      /* Estilos mantidos para o layout Bootstrap */
      .form-container { padding-top: 20px; background-color: var(--bg-light-form); }
      .main-card { max-width: 600px; margin: 0 auto 40px auto; background: var(--white); border-radius: var(--border-radius); box-shadow: 0 6px 20px var(--shadow); overflow: hidden; }
      .header-form { background: var(--gradient); color: var(--white); padding: 20px; text-align: center; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 1.5rem; }
      .form-content { padding: 25px; }
      .section-label { color: var(--primary-color); font-weight: 800; text-transform: uppercase; font-size: 0.9rem; margin-top: 25px; border-bottom: 2px solid var(--secondary-color); padding-bottom: 5px; margin-bottom: 15px; }
      .form-control, .form-select { border-radius: var(--border-radius); border: 1px solid var(--tertiary-color); color: var(--text-dark); transition: var(--transition); }
      .form-control:focus, .form-select:focus { box-shadow: 0 0 0 0.25rem rgba(93, 63, 211, 0.25); border-color: var(--primary-color); background-color: var(--bg-light-form); }
      .input-group-text { min-width: 140px; font-size: 0.9rem; background-color: var(--bg-light-form); color: var(--text-dark); border: 1px solid var(--tertiary-color); border-right: none; border-radius: var(--border-radius) 0 0 var(--border-radius); }
      .bg-warning { background-color: #ffc107 !important; color: var(--text-dark) !important; font-weight: bold; }
      .btn-send { height: 50px; font-weight: bold; font-size: 1.1rem; background-color: var(--primary-color); color: var(--white); border: none; border-radius: var(--border-radius); transition: var(--transition); box-shadow: 0 4px 10px rgba(93, 63, 211, 0.4); }
      .btn-send:hover, .btn-send:focus { background-color: var(--secondary-color); box-shadow: 0 6px 15px rgba(93, 63, 211, 0.6); transform: translateY(-2px); }
      .btn-send:disabled { background-color: var(--tertiary-color) !important; box-shadow: none !important; transform: none !important; }
      .form-check-input:checked { background-color: var(--primary-color); border-color: var(--primary-color); }
      .form-check-label { color: var(--text-dark); }
      .bg-light.rounded.border { background-color: rgba(93, 63, 211, 0.05) !important; border-color: rgba(93, 63, 211, 0.2) !important; }
      .alert-success-custom { background-color: var(--accent-color); color: var(--text-dark); border-color: var(--primary-color); font-weight: bold; text-align: center; margin-top: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; color: var(--text-dark); line-height: 1.6; font-size: 14px; background-color: #fff; }
      /* Oculta os elementos de Apps Script n√£o necess√°rios */
      head > base { display: none; }
    </style>
</head>
<body>
    
    <div class="menu-overlay"></div>
    <aside class="side-menu">
        <a href="index.html"><i class="fas fa-home"></i> In√≠cio</a>
        <a href="estoque.html" class="active"><i class="fas fa-boxes-stacked"></i> Estoque</a>
        <a href="caixas.html"><i class="fas fa-box-open"></i> Caixas</a>
        <a href="camera.html"><i class="fas fa-camera"></i> C√¢mera</a>
        <a href="relatorio.html"><i class="fas fa-camera"></i> Relat√≥rio/Qualidade</a>
    </aside>
    <header id="cabecalho-principal">
        <button class="menu-toggle" aria-label="Abrir Menu">
            <i class="fas fa-bars"></i>
        </button>
        <div class="logo-placeholder">
            <img src="./images/logo-qdelicia.png" alt="Logomarca Qdel√≠cia Frutas"> 
        </div>
        <h1>Qdel√≠cia Frutas</h1>
        <p>Registro de estoque di√°rio</p>
    </header>

    <nav>
        <a href="index.html">In√≠cio</a>
        <a href="estoque.html" class="active">Estoque</a>
        <a href="caixas.html">Caixas</a>
        <a href="camera.html">C√¢mera</a>
        <a href="relatorio.html">Relat√≥rio/Qualidade</a>
    </nav>
    
    <div class="container form-container">
      <div class="main-card">
        
        <div class="header-form">
          <h4 class="mb-0">Relat√≥rio de Estoque (Caixas)</h4>
        </div>
        
        <div class="form-content">
          <form id="stockForm" onsubmit="handleFormSubmit(this)">
            
            <div class="section-label">Dados do Promotor e Localiza√ß√£o</div>
            
            <div class="mb-3">
              <label class="form-label fw-bold">Estado</label>
              <select class="form-select" id="estado" name="estado" required onchange="updateRede()">
                <option value="" disabled selected>Selecione...</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Rede</label>
              <select class="form-select" id="rede" name="rede" required disabled onchange="updatePromotor()">
                <option value="" disabled selected>Selecione a Rede...</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Promotor</label>
              <select class="form-select" id="nome" name="nome" required disabled onchange="updateLoja()">
                <option value="" disabled selected>Selecione o Promotor...</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label class="form-label fw-bold">Loja</label>
              <select class="form-select" id="loja" name="loja" required disabled>
                <option value="" disabled selected>Selecione a Loja...</option>
              </select>
            </div>

            <div class="mb-3 p-3 bg-light rounded border">
              <label class="form-label fw-bold d-block">O caminh√£o descarregou?</label>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="descarregou" value="Sim" required id="descSim">
                <label class="form-check-label" for="descSim">Sim</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="descarregou" value="N√£o" id="descNao">
                <label class="form-check-label" for="descNao">N√£o</label>
              </div>
            </div>

            <div class="section-label">Quantidades (Caixas)</div>
            <p class="text-muted small">Insira a quantidade de caixas. (Abacaxi √© em UNIDADES)</p>

            <div class="fw-bold mt-3 text-secondary">Banana Pacovan:</div>
            <div class="input-group mb-2">
              <span class="input-group-text">Pacovan P</span>
              <input type="number" class="form-control" name="pacoP" placeholder="0" min="0">
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text">Pacovan G</span>
              <input type="number" class="form-control" name="pacoG" placeholder="0" min="0">
            </div>

            <div class="fw-bold mt-3 text-secondary">Banana Prata:</div>
            <div class="input-group mb-2">
              <span class="input-group-text">Prata P</span>
              <input type="number" class="form-control" name="prataP" placeholder="0" min="0">
            </div>
            <div class="input-group mb-2">
              <span class="input-group-text">Prata G</span>
              <input type="number" class="form-control" name="prataG" placeholder="0" min="0">
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text">Prata IFCO</span>
              <input type="number" class="form-control" name="prataIfco" placeholder="0" min="0">
            </div>

            <div class="fw-bold mt-3 text-secondary">Banana Nanica:</div>
            <div class="input-group mb-2">
              <span class="input-group-text">Nanica P</span>
              <input type="number" class="form-control" name="nanicaP" placeholder="0" min="0">
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text">Nanica G</span>
              <input type="number" class="form-control" name="nanicaG" placeholder="0" min="0">
            </div>

            <div class="fw-bold mt-3 text-secondary">Banana Comprida:</div>
            <div class="input-group mb-2">
              <span class="input-group-text">Comprida P</span>
              <input type="number" class="form-control" name="compP" placeholder="0" min="0">
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text">Comprida G</span>
              <input type="number" class="form-control" name="compG" placeholder="0" min="0">
            </div>

            <div class="fw-bold mt-3 text-secondary">Banana Leite:</div>
            <div class="input-group mb-2">
              <span class="input-group-text">Leite P</span>
              <input type="number" class="form-control" name="leiteP" placeholder="0" min="0">
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text">Leite G</span>
              <input type="number" class="form-control" name="leiteG" placeholder="0" min="0">
            </div>

            <div class="fw-bold mt-3 text-secondary">Outras Frutas:</div>
            <div class="input-group mb-2">
              <span class="input-group-text">Goiaba (CX)</span>
              <input type="number" class="form-control" name="goiaba" placeholder="0" min="0">
            </div>
            <div class="input-group mb-2">
              <span class="input-group-text">Mel√£o P (CX)</span>
              <input type="number" class="form-control" name="melao" placeholder="0" min="0">
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text bg-warning text-dark fw-bold">Abacaxi (UND)</span>
              <input type="number" class="form-control" name="abacaxi" placeholder="0" min="0">
            </div>

            <div class="section-label">Observa√ß√µes</div>
            <div class="mb-3">
              <textarea class="form-control" name="obs" rows="2" placeholder="Informa√ß√µes adicionais relevantes..."></textarea>
            </div>
            
            <div id="statusMessage" class="alert d-none" role="alert"></div>

            <div class="d-grid gap-2">
              <button type="submit" id="btnSubmit" class="btn btn-send">ENVIAR RELAT√ìRIO</button>
            </div>
          </form>
        </div>
      </div>
    </div>
        
    <footer>
        <p>&copy; 2025 Qdel√≠cia Frutas. Todos os direitos reservados.</p>
    </footer>

    <a href="https://wa.me/5581997250086" class="whatsapp-btn" target="_blank">
        <i class="fab fa-whatsapp"></i>
    </a>

    <div class="back-to-top">
        <i class="fas fa-arrow-up"></i>
    </div>

    <script src="script.js"></script>
    <script src="alert.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ‚ö†Ô∏è SUBSTITUA ESTE VALOR PELO SEU URL DE IMPLANTA√á√ÉO DO APPS SCRIPT
        const GOOGLE_SCRIPT_URL = "https://SEU-URL-DE-IMPLANTACAO-DO-APPSCRIPT/exec";
        
        // --- CONFIGURA√á√ÉO DE ESTADOS, REDES, PROMOTORES E LOJAS (REUTILIZADA) ---
        const db = {
            "RN": {
              "Atacad√£o": {
                "Vivian": ["BR - Zona Sul"],
                "Nilson": ["Parnamirim"],
                "In√°cio": ["Prudente"],
                "Amarildo": ["Zona Norte"],
                "J Maur√≠cio": ["Prudente"]
              },
              "Assa√≠": {
                "Reginaldo": ["Zona Sul"],
                "Erivan": ["Maria Lacerda"],
                "Miqueias": ["Ponta Negra"],
                "Cosme": ["Zona Norte"]
              },
              "Nordest√£o": {
                "J Mauricio": ["Loja 03"],
                "Mateus": ["Loja 04"],
                "Amarildo": ["Loja 05"],
                "Cristiane": ["Loja 07"],
                "Reginaldo": ["Loja 08"],
                "Markson": ["Loja 03"]
              },
              "Carrefour": {
                "Mateus": ["Zona Sul"]
              },
              "Superf√°cil": {
                "Neto": ["Ema√∫s"],
                "David": ["Nazar√©"],
                "0000": ["Olho d√°gua"]
              },
              "Mar Vermelho": {
                "Markson": ["Natal","Parnamirim"]  
              }
            },
            "PE": {
              "Rede A": {
                "Sandro Santos": ["AB", "AC"],
                "Jos√© Lima": ["AB"]
              },
              "Rede B": {
                "Paulo Santos": ["ABC"]  
              }
            },
            "AL": {
              "Rede C": {
                "Pedro Santos": ["AB", "AC"],
                "Gabriel Lima": ["AB"]
              },
              "Rede D": {
                "Miguel Santos": ["ABC"]  
              }
            },
            "PB": {
              "Rede F": {
                "Joao Santos": ["AB", "AC"],
                "Mario Lima": ["AB"]
              },
              "Rede G": {
                "Jefferson Santos": ["ABC"]  
              }
            }
          };
        // ------------------------------------------------

        const selEstado = document.getElementById("estado");
        const selRede = document.getElementById("rede");
        const selLoja = document.getElementById("loja");
        const selNome = document.getElementById("nome"); 
        const btn = document.getElementById("btnSubmit");
        const statusMessage = document.getElementById('statusMessage');
        
        // Inicializa Estados
        for (let uf in db) {
          selEstado.options[selEstado.options.length] = new Option(uf, uf);
        }
        
        // Fun√ß√µes de Dropdown (Mantidas)
        function updateDropdown(element, optionsArray, defaultText) {
            let optionsHtml = `<option value="" disabled selected>${defaultText}</option>`;
            const uniqueOptions = [...new Set(optionsArray)];
            uniqueOptions.forEach(opt => {
                optionsHtml += `<option value="${opt}">${opt}</option>`;
            });
            element.innerHTML = optionsHtml;
        }

        function updateRede() {
          updateDropdown(selRede, [], "Selecione a Rede...");
          updateDropdown(selNome, [], "Selecione o Promotor...");
          updateDropdown(selLoja, [], "Selecione a Loja...");
          
          selRede.disabled = true; selNome.disabled = true; selLoja.disabled = true;
          
          if (selEstado.value) {
            selRede.disabled = false;
            let redes = db[selEstado.value];
            let redesArray = Object.keys(redes);
            updateDropdown(selRede, redesArray, "Selecione a Rede...");
          }
        }

        function updatePromotor() {
          updateDropdown(selNome, [], "Selecione o Promotor...");
          updateDropdown(selLoja, [], "Selecione a Loja...");
          
          selNome.disabled = true; selLoja.disabled = true;
          
          if (selRede.value) {
            selNome.disabled = false;
            let promotoresObj = db[selEstado.value][selRede.value];
            let promotoresArray = Object.keys(promotoresObj);
            updateDropdown(selNome, promotoresArray, "Selecione o Promotor...");
          }
        }

        function updateLoja() {
          updateDropdown(selLoja, [], "Selecione a Loja...");
          
          selLoja.disabled = true;
          
          if (selNome.value) {
            selLoja.disabled = false;
            let lojasArray = db[selEstado.value][selRede.value][selNome.value];
            updateDropdown(selLoja, lojasArray, "Selecione a Loja...");
          }
        }

        // Fun√ß√µes de Status (Mantidas)
        function showStatus(message, type = 'success') {
            statusMessage.textContent = message;
            statusMessage.classList.remove('d-none', 'alert-danger', 'alert-success-custom');
            
            if (type === 'success') {
                statusMessage.classList.add('alert-success-custom');
                statusMessage.classList.remove('alert-danger');
            } else if (type === 'error') {
                statusMessage.classList.add('alert-danger');
                statusMessage.classList.remove('alert-success-custom');
            }
        }
        
        function hideStatus() {
            statusMessage.classList.add('d-none');
            statusMessage.textContent = '';
        }

        /**
         * Fun√ß√£o principal de envio do formul√°rio, ADAPTADA para o Apps Script como API (via fetch).
         */
        async function handleFormSubmit(formObject) {
            event.preventDefault();
            
            hideStatus(); 

            const formData = new FormData(formObject);
            const data = Object.fromEntries(formData.entries()); 
            
            // üõë PASSO CRUCIAL: Identifica o formul√°rio para o Apps Script
            data.formType = "estoque";

            // --- VALIDA√á√ÉO DE OBRIGATORIEDADE DE CAIXAS/UNIDADES ---
            let totalProdutos = 0;
            ['pacoP', 'pacoG', 'prataP', 'prataG', 'prataIfco', 'nanicaP', 'nanicaG', 'compP', 'compG', 'leiteP', 'leiteG', 'goiaba', 'melao', 'abacaxi'].forEach(key => {
                const value = parseInt(data[key] || 0); 
                if (!isNaN(value) && value > 0) {
                    totalProdutos += value;
                }
            });

            if (totalProdutos === 0) {
                showStatus("‚ùå ERRO: Pelo menos um tipo de produto deve ter valor maior que zero.", 'error');
                return;
            }
            // --- FIM DA VALIDA√á√ÉO ---
            
            btn.disabled = true;
            btn.textContent = "Calculando e Enviando...";

            try {
                // üöÄ COMUNICA√á√ÉO REAL VIA FETCH
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        // Apps Script prefere 'text/plain' ao inv√©s de 'application/json' no POST para evitar alguns problemas de CORS/pre-flight
                        'Content-Type': 'text/plain;charset=utf-8', 
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`Erro de rede: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    // Sucesso
                    document.getElementById("stockForm").reset();
                    updateRede(); // Reseta os dropdowns de localiza√ß√£o
                    
                    showStatus("‚úÖ SUCESSO! " + result.message, 'success');
                    
                    // Redirecionamento ap√≥s 2 segundos
                    setTimeout(function() {
                        window.location.href = "estoque.html"; // Auto-refresh na mesma p√°gina
                    }, 2000); 

                } else {
                    // Falha l√≥gica retornada pelo Apps Script (result.success √© false)
                    throw new Error(result.message);
                }

            } catch (error) {
                // Trata erros de rede, parse ou falha l√≥gica
                console.error("Erro no fetch:", error);
                showStatus(`‚ùå ERRO AO ENVIAR: ${error.message || "Falha desconhecida"}`, 'error');

            } finally {
                btn.disabled = false;
                btn.textContent = "ENVIAR RELAT√ìRIO";
            }
        }
        
        window.onload = function() {
          updateRede(); 
        };  
    </script>
</body>
</html>
